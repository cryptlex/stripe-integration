import createClient from "openapi-fetch";
import { afterAll, afterEach, beforeAll, expect, test, vi } from "vitest";
import type { paths } from "@cryptlex/web-api-types"; // generated by openapi-typescript
import { server } from "../../mock-server/node";
import { baseURL as MswBaseUrl } from "../../mock-server/handlers";
import { handleOrderCreated } from "../lib/eventHandlers/handleOrderCreated";

beforeAll(() => {
  // NOTE: server.listen must be called before `createClient` is used to ensure
  // the msw can inject its version of `fetch` to intercept the requests.
  server.listen({
    onUnhandledRequest: (request) => {
      throw new Error(
        `No request handler found for ${request.method} ${request.url}`
      );
    },
  });
});

afterEach(() => server.resetHandlers());
afterAll(() => server.close());

test("Handle Order Completed flow ( subscription based )", async () => {
  const client = createClient<paths>({
    baseUrl: MswBaseUrl,
  });

  await handleOrderCreated(client,
    {"id":"qwerty",
      "data": {
    order: "D3SlcOuDQ6uzHNjDRfghFQ",
    id: "D3SlcOuDQ6uzHNjDRfghFQ",
    reference: "TESTING123250128-9059-91128",
    buyerReference: null,
    ipAddress: "117.96.43.27",
    completed: true,
    changed: 1738052653763,
    changedValue: 1738052653763,
    changedInSeconds: 1738052653,
    changedDisplay: "28/01/25",
    changedDisplayISO8601: "2025-01-28",
    changedDisplayEmailEnhancements: "Jan 28, 2025",
    changedDisplayEmailEnhancementsWithTime: "Jan 28, 2025 08:24:13 AM",
    language: "en",
    live: false,
    currency: "INR",
    payoutCurrency: "USD",
    quote: null,
    invoiceUrl:
      "https://123test.test.onfastspring.com/test-678/account/order/TESTING123250128-9059-91128/invoice/IVMICZKAHJ7FHNHHUD3KFZI76EVQ",
    siteId: "CM4VSRBUQRBH6",
    account: {
      id: "qnYDZEU4Qxif6obT805fFA",
      account: "qnYDZEU4Qxif6obT805fFA",
      contact: {
        first: "test",
        last: "test",
        email: "test@test.com",
        company: null,
        phone: null,
        subscribed: true,
      },
      address: {
        "address line 1": null,
        "address line 2": null,
        city: null,
        country: "IN",
        "postal code": null,
        region: null,
        "region custom": null,
        company: null,
      },
      language: "en",
      country: "IN",
      lookup: { global: "TdcoJCA0T_yLu03lLQ0XfQ" },
      url: "https://123test.test.onfastspring.com/account",
    },
    total: 5380.8,
    totalDisplay: "₹ 5,380.80",
    totalInPayoutCurrency: 58.88,
    totalInPayoutCurrencyDisplay: "US$ 58.88",
    tax: 820.8,
    taxDisplay: "₹ 820.80",
    taxInPayoutCurrency: 8.98,
    taxInPayoutCurrencyDisplay: "US$ 8.98",
    subtotal: 4560.0,
    subtotalDisplay: "₹ 4,560.00",
    subtotalInPayoutCurrency: 49.9,
    subtotalInPayoutCurrencyDisplay: "US$ 49.90",
    discount: 0.0,
    discountDisplay: "₹ 0.00",
    discountInPayoutCurrency: 0.0,
    discountInPayoutCurrencyDisplay: "US$ 0.00",
    discountWithTax: 0.0,
    discountWithTaxDisplay: "₹ 0.00",
    discountWithTaxInPayoutCurrency: 0.0,
    discountWithTaxInPayoutCurrencyDisplay: "US$ 0.00",
    billDescriptor: "FS* fsprg.com",
    payment: { type: "test", cardEnding: "4242" },
    customer: {
      first: "test",
      last: "test",
      email: "test@test.com",
      company: null,
      phone: null,
      subscribed: true,
    },
    address: { country: "IN", display: "IN" },
    recipients: [
      {
        recipient: {
          first: "test",
          last: "test",
          email: "test@test.com",
          company: null,
          phone: null,
          subscribed: true,
          account: {
            id: "qnYDZEU4Qxif6obT805fFA",
            account: "qnYDZEU4Qxif6obT805fFA",
            contact: {
              first: "test",
              last: "test",
              email: "test@test.com",
              company: null,
              phone: null,
              subscribed: true,
            },
            address: {
              "address line 1": null,
              "address line 2": null,
              city: null,
              country: "IN",
              "postal code": null,
              region: null,
              "region custom": null,
              company: null,
            },
            language: "en",
            country: "IN",
            lookup: { global: "TdcoJCA0T_yLu03lLQ0XfQ" },
            url: "https://123test.test.onfastspring.com/account",
          },
          address: { country: "IN", display: "IN" },
        },
      },
    ],
    notes: [],
    items: [
      {
        product: "test-subscription",
        quantity: 5,
        display: "test-subscription",
        sku: "yyu",
        imageUrl: null,
        shortDisplay: "test-subscription",
        subtotal: 4560.0,
        subtotalDisplay: "₹ 4,560.00",
        subtotalInPayoutCurrency: 49.9,
        subtotalInPayoutCurrencyDisplay: "US$ 49.90",
        attributes: {
          cryptlex_product_id: "2345678",
          cryptlex_license_policy_id: "126",
          qwer: "676879",
        },
        discount: 0.0,
        discountDisplay: "₹ 0.00",
        discountInPayoutCurrency: 0.0,
        discountInPayoutCurrencyDisplay: "US$ 0.00",
        isSubscription: true,
        subscription: {
          id: "YiJdBYzzT92VsN-t3FTIwQ",
          quote: null,
          subscription: "YiJdBYzzT92VsN-t3FTIwQ",
          active: true,
          state: "active",
          isSubscriptionEligibleForPauseByBuyer: false,
          isPauseScheduled: false,
          changed: 1738052653714,
          changedValue: 1738052653714,
          changedInSeconds: 1738052653,
          changedDisplay: "28/01/25",
          changedDisplayISO8601: "2025-01-28",
          changedDisplayEmailEnhancements: "Jan 28, 2025",
          changedDisplayEmailEnhancementsWithTime: "Jan 28, 2025 08:24:13 AM",
          live: false,
          currency: "INR",
          account: "qnYDZEU4Qxif6obT805fFA",
          product: "test-subscription",
          sku: "yyu",
          display: "test-subscription",
          quantity: 5,
          adhoc: false,
          autoRenew: true,
          price: 912.0,
          priceDisplay: "₹ 912.00",
          priceInPayoutCurrency: 9.98,
          priceInPayoutCurrencyDisplay: "US$ 9.98",
          discount: 0.0,
          discountDisplay: "₹ 0.00",
          discountInPayoutCurrency: 0.0,
          discountInPayoutCurrencyDisplay: "US$ 0.00",
          subtotal: 4560.0,
          subtotalDisplay: "₹ 4,560.00",
          subtotalInPayoutCurrency: 49.9,
          subtotalInPayoutCurrencyDisplay: "US$ 49.90",
          attributes: {
            cryptlex_product_id: "2345678",
            cryptlex_license_policy_id: "126",
            qwer: "676879",
          },
          next: 1740700800000,
          nextValue: 1740700800000,
          nextInSeconds: 1740700800,
          nextDisplay: "28/02/25",
          nextDisplayISO8601: "2025-02-28",
          end: null,
          endValue: null,
          endInSeconds: null,
          endDisplay: null,
          endDisplayISO8601: null,
          canceledDate: null,
          canceledDateValue: null,
          canceledDateInSeconds: null,
          canceledDateDisplay: null,
          canceledDateDisplayISO8601: null,
          deactivationDate: null,
          deactivationDateValue: null,
          deactivationDateInSeconds: null,
          deactivationDateDisplay: null,
          deactivationDateDisplayISO8601: null,
          sequence: 1,
          periods: null,
          remainingPeriods: null,
          begin: 1738052653354,
          beginValue: 1738052653354,
          beginInSeconds: 1738052653,
          beginDisplay: "28/01/25",
          beginDisplayISO8601: "2025-01-28",
          beginDisplayEmailEnhancements: "Jan 28, 2025",
          beginDisplayEmailEnhancementsWithTime: "Jan 28, 2025 08:24:13 AM",
          nextDisplayEmailEnhancements: "Feb 28, 2025",
          nextDisplayEmailEnhancementsWithTime: "Feb 28, 2025 12:00:00 AM",
          intervalUnit: "month",
          intervalUnitAbbreviation: "mo",
          intervalLength: 1,
          intervalLengthGtOne: false,
          nextChargeCurrency: "INR",
          nextChargeDate: 1740700800000,
          nextChargeDateValue: 1740700800000,
          nextChargeDateInSeconds: 1740700800,
          nextChargeDateDisplay: "28/02/25",
          nextChargeDateDisplayISO8601: "2025-02-28",
          nextChargePreTax: 4560.0,
          nextChargePreTaxDisplay: "₹ 4,560.00",
          nextChargePreTaxInPayoutCurrency: 49.9,
          nextChargePreTaxInPayoutCurrencyDisplay: "US$ 49.90",
          nextChargeTotal: 5380.8,
          nextChargeTotalDisplay: "₹ 5,380.80",
          nextChargeTotalInPayoutCurrency: 58.88,
          nextChargeTotalInPayoutCurrencyDisplay: "US$ 58.88",
          nextNotificationType: "PAYMENT_REMINDER",
          nextNotificationDate: 1740096000000,
          nextNotificationDateValue: 1740096000000,
          nextNotificationDateInSeconds: 1740096000,
          nextNotificationDateDisplay: "21/02/25",
          nextNotificationDateDisplayISO8601: "2025-02-21",
          paymentReminder: { intervalUnit: "week", intervalLength: 1 },
          paymentOverdue: {
            intervalUnit: "week",
            intervalLength: 1,
            total: 4,
            sent: 0,
          },
          cancellationSetting: {
            cancellation: "AFTER_LAST_NOTIFICATION",
            intervalUnit: "week",
            intervalLength: 1,
          },
          fulfillments: {},
          instructions: [
            {
              product: "test-subscription",
              type: "regular",
              isNotTrial: true,
              periodStartDate: 1738022400000,
              periodStartDateValue: 1738022400000,
              periodStartDateInSeconds: 1738022400,
              periodStartDateDisplay: "28/01/25",
              periodStartDateDisplayISO8601: "2025-01-28",
              periodEndDate: null,
              periodEndDateValue: null,
              periodEndDateInSeconds: null,
              periodEndDateDisplay: null,
              periodEndDateDisplayISO8601: null,
              intervalUnit: "month",
              intervalLength: 1,
              discountPercent: 0,
              discountPercentValue: 0,
              discountPercentDisplay: "0%",
              discountTotal: 0.0,
              discountTotalDisplay: "₹ 0.00",
              discountTotalInPayoutCurrency: 0.0,
              discountTotalInPayoutCurrencyDisplay: "US$ 0.00",
              unitDiscount: 0.0,
              unitDiscountDisplay: "₹ 0.00",
              unitDiscountInPayoutCurrency: 0.0,
              unitDiscountInPayoutCurrencyDisplay: "US$ 0.00",
              price: 912.0,
              priceDisplay: "₹ 912.00",
              priceInPayoutCurrency: 9.98,
              priceInPayoutCurrencyDisplay: "US$ 9.98",
              priceTotal: 4560.0,
              priceTotalDisplay: "₹ 4,560.00",
              priceTotalInPayoutCurrency: 49.9,
              priceTotalInPayoutCurrencyDisplay: "US$ 49.90",
              unitPrice: 912.0,
              unitPriceDisplay: "₹ 912.00",
              unitPriceInPayoutCurrency: 9.98,
              unitPriceInPayoutCurrencyDisplay: "US$ 9.98",
              total: 4560.0,
              totalDisplay: "₹ 4,560.00",
              totalInPayoutCurrency: 49.9,
              totalInPayoutCurrencyDisplay: "US$ 49.90",
              totalWithTaxes: 5380.8,
              totalWithTaxesDisplay: "₹ 5,380.80",
              totalWithTaxesInPayoutCurrency: 58.88,
              totalWithTaxesInPayoutCurrencyDisplay: "US$ 58.88",
            },
          ],
          initialOrderId: "D3SlcOuDQ6uzHNjDRfghFQ",
          initialOrderReference: "TESTING123250128-9059-91128",
        },
        fulfillments: {},
        withholdings: { taxWithholdings: false },
        proratedItemChangeAmount: 0.0,
        proratedItemChangeAmountDisplay: "₹ 0.00",
        proratedItemChangeAmountInPayoutCurrency: 0.0,
        proratedItemChangeAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemProratedCharge: 0.0,
        proratedItemProratedChargeDisplay: "₹ 0.00",
        proratedItemProratedChargeInPayoutCurrency: 0.0,
        proratedItemProratedChargeInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemCreditAmount: 0.0,
        proratedItemCreditAmountDisplay: "₹ 0.00",
        proratedItemCreditAmountInPayoutCurrency: 0.0,
        proratedItemCreditAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemTaxAmount: 0.0,
        proratedItemTaxAmountDisplay: "₹ 0.00",
        proratedItemTaxAmountInPayoutCurrency: 0.0,
        proratedItemTaxAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemTotal: 0.0,
        proratedItemTotalDisplay: "₹ 0.00",
        proratedItemTotalInPayoutCurrency: 0.0,
        proratedItemTotalInPayoutCurrencyDisplay: "US$ 0.00",
      },
    ],
  }
});
});

test("Handle Order Completed flow ( one time perpetual )", async () => {
  const client = createClient<paths>({
    baseUrl: MswBaseUrl,
  });

  await handleOrderCreated(client,  {"id":"qwerty",
    "data": {
    order: "DIjRdMPZT6eQINNlXyaRxg",
    id: "DIjRdMPZT6eQINNlXyaRxg",
    reference: "TESTING123250127-4372-16112",
    buyerReference: null,
    ipAddress: "117.96.43.174",
    completed: true,
    changed: 1737953042422,
    changedValue: 1737953042422,
    changedInSeconds: 1737953042,
    changedDisplay: "27/01/25",
    changedDisplayISO8601: "2025-01-27",
    changedDisplayEmailEnhancements: "Jan 27, 2025",
    changedDisplayEmailEnhancementsWithTime: "Jan 27, 2025 04:44:02 AM",
    language: "en",
    live: false,
    currency: "INR",
    payoutCurrency: "USD",
    quote: null,
    invoiceUrl:
      "https://123test.test.onfastspring.com/account/order/TESTING123250127-4372-16112/invoice/IVRSD4FU5AKNAU3JWWSP7BUB5MLA",
    siteId: "CM4VSRBUQRBH6",
    account: "qnYDZEU4Qxif6obT805fFA",
    total: 9659.48,
    totalDisplay: "₹ 9,659.48",
    totalInPayoutCurrency: 105.89,
    totalInPayoutCurrencyDisplay: "US$ 105.89",
    tax: 1473.48,
    taxDisplay: "₹ 1,473.48",
    taxInPayoutCurrency: 16.15,
    taxInPayoutCurrencyDisplay: "US$ 16.15",
    subtotal: 8186.0,
    subtotalDisplay: "₹ 8,186.00",
    subtotalInPayoutCurrency: 89.73,
    subtotalInPayoutCurrencyDisplay: "US$ 89.73",
    discount: 0.0,
    discountDisplay: "₹ 0.00",
    discountInPayoutCurrency: 0.0,
    discountInPayoutCurrencyDisplay: "US$ 0.00",
    discountWithTax: 0.0,
    discountWithTaxDisplay: "₹ 0.00",
    discountWithTaxInPayoutCurrency: 0.0,
    discountWithTaxInPayoutCurrencyDisplay: "US$ 0.00",
    billDescriptor: "FS* fsprg.com",
    payment: { type: "test", cardEnding: "4242" },
    customer: {
      first: "test",
      last: "test",
      email: "test@test.com",
      company: null,
      phone: null,
      subscribed: true,
    },
    address: { country: "IN", display: "IN" },
    recipients: [
      {
        recipient: {
          first: "test",
          last: "test",
          email: "test@test.com",
          company: null,
          phone: null,
          subscribed: true,
          account: "qnYDZEU4Qxif6obT805fFA",
          address: { country: "IN", display: "IN" },
        },
      },
    ],
    notes: [],
    items: [
      {
        product: "test-123",
        quantity: 1,
        display: "test",
        sku: null,
        imageUrl: null,
        shortDisplay: "test",
        subtotal: 8186.0,
        subtotalDisplay: "₹ 8,186.00",
        subtotalInPayoutCurrency: 89.73,
        subtotalInPayoutCurrencyDisplay: "US$ 89.73",
        attributes: {
          cryptlex_product_id: "2345678",
          cryptlex_license_policy_id: "126",
          qwer: "676879",
        },
        discount: 0.0,
        discountDisplay: "₹ 0.00",
        discountInPayoutCurrency: 0.0,
        discountInPayoutCurrencyDisplay: "US$ 0.00",
        isAddon: true,
        fulfillments: {
          "test-123_license_0": [
            { license: "test test_1", type: "license", display: "License Key" },
          ],
          "test-123_license_1": [
            { license: "test test_1", type: "license", display: "License Key" },
          ],
        },
        withholdings: { taxWithholdings: false },
        proratedItemChangeAmount: 0.0,
        proratedItemChangeAmountDisplay: "₹ 0.00",
        proratedItemChangeAmountInPayoutCurrency: 0.0,
        proratedItemChangeAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemProratedCharge: 0.0,
        proratedItemProratedChargeDisplay: "₹ 0.00",
        proratedItemProratedChargeInPayoutCurrency: 0.0,
        proratedItemProratedChargeInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemCreditAmount: 0.0,
        proratedItemCreditAmountDisplay: "₹ 0.00",
        proratedItemCreditAmountInPayoutCurrency: 0.0,
        proratedItemCreditAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemTaxAmount: 0.0,
        proratedItemTaxAmountDisplay: "₹ 0.00",
        proratedItemTaxAmountInPayoutCurrency: 0.0,
        proratedItemTaxAmountInPayoutCurrencyDisplay: "US$ 0.00",
        proratedItemTotal: 0.0,
        proratedItemTotalDisplay: "₹ 0.00",
        proratedItemTotalInPayoutCurrency: 0.0,
        proratedItemTotalInPayoutCurrencyDisplay: "US$ 0.00",
      },
    ],
  }});
});
