import createClient from "openapi-fetch";
import { afterAll, afterEach, beforeAll, expect, test, vi } from "vitest";
import type { paths } from "@cryptlex/web-api-types"; // generated by openapi-typescript
import { server } from "../../mock-server/node";
import { baseURL as MswBaseUrl } from "../../mock-server/handlers";
import { handleSubscriptionDeactivated } from "../lib/eventHandlers/handleSubscriptionDeactivated";

beforeAll(() => {
  // NOTE: server.listen must be called before `createClient` is used to ensure
  // the msw can inject its version of `fetch` to intercept the requests.
  server.listen({
    onUnhandledRequest: (request) => {
      throw new Error(
        `No request handler found for ${request.method} ${request.url}`
      );
    },
  });
});

afterEach(() => server.resetHandlers());
afterAll(() => server.close());

test("Handle Order Completed flow", async () => {
  const client = createClient<paths>({
    baseUrl: MswBaseUrl,
  });

  await handleSubscriptionDeactivated(client, {"id":"qwerty",
    "data": {
    id: "TAUFmEVOQNmiOltXzPjoKA",
    quote: null,
    subscription: "TAUFmEVOQNmiOltXzPjoKA",
    active: false,
    state: "deactivated",
    isSubscriptionEligibleForPauseByBuyer: false,
    isPauseScheduled: false,
    changed: 1738132720734,
    changedValue: 1738132720734,
    changedInSeconds: 1738132720,
    changedDisplay: "29/01/25",
    changedDisplayISO8601: "2025-01-29",
    changedDisplayEmailEnhancements: "Jan 29, 2025",
    changedDisplayEmailEnhancementsWithTime: "Jan 29, 2025 06:38:40 AM",
    live: false,
    currency: "INR",
    account: {
      id: "qnYDZEU4Qxif6obT805fFA",
      account: "qnYDZEU4Qxif6obT805fFA",
      contact: {
        first: "test",
        last: "test",
        email: "test@test.com",
        company: null,
        phone: null,
        subscribed: true,
      },
      address: {
        "address line 1": null,
        "address line 2": null,
        city: null,
        country: "IN",
        "postal code": null,
        region: null,
        "region custom": null,
        company: null,
      },
      language: "en",
      country: "IN",
      lookup: { global: "TdcoJCA0T_yLu03lLQ0XfQ" },
      url: "https://123test.test.onfastspring.com/account",
    },
    product: {
      product: "test-subscription",
      parent: null,
      productAppReference: "Bf9_zIXxTPSp-EO0dU1UAA",
      display: { en: "test-subscription" },
      description: { summary: { en: "testing" } },
      sku: "yyu",
      fulfillments: {},
      format: "digital",
      taxcode: "SW054002",
      taxcodeDescription: "Cloud Services - SaaS - Services agreement",
      attributes: { hjgvjhgui: "2345678", test: "126", qwer: "676879" },
      pricing: {
        interval: "month",
        intervalLength: 1,
        intervalCount: null,
        quantityBehavior: "allow",
        quantityDefault: 5,
        price: { USD: 10.0 },
        dateLimitsEnabled: false,
        reminderNotification: {
          enabled: true,
          interval: "week",
          intervalLength: 1,
        },
        overdueNotification: {
          enabled: true,
          interval: "week",
          intervalLength: 1,
          amount: 4,
        },
        cancellation: { interval: "week", intervalLength: 1 },
      },
    },
    sku: "yyu",
    display: "test-subscription",
    quantity: 1,
    adhoc: false,
    autoRenew: true,
    price: 914.0,
    priceDisplay: "₹ 914.00",
    priceInPayoutCurrency: 10.0,
    priceInPayoutCurrencyDisplay: "US$ 10.00",
    discount: 0.0,
    discountDisplay: "₹ 0.00",
    discountInPayoutCurrency: 0.0,
    discountInPayoutCurrencyDisplay: "US$ 0.00",
    subtotal: 914.0,
    subtotalDisplay: "₹ 914.00",
    subtotalInPayoutCurrency: 10.0,
    subtotalInPayoutCurrencyDisplay: "US$ 10.00",
    attributes: { hjgvjhgui: "2345678", test: "126", qwer: "676879" },
    next: 1740700800000,
    nextValue: 1740700800000,
    nextInSeconds: 1740700800,
    nextDisplay: "28/02/25",
    nextDisplayISO8601: "2025-02-28",
    end: 1738108800000,
    endValue: 1738108800000,
    endInSeconds: 1738108800,
    endDisplay: "29/01/25",
    endDisplayISO8601: "2025-01-29",
    canceledDate: 1738108800000,
    canceledDateValue: 1738108800000,
    canceledDateInSeconds: 1738108800,
    canceledDateDisplay: "29/01/25",
    canceledDateDisplayISO8601: "2025-01-29",
    deactivationDate: 1738108800000,
    deactivationDateValue: 1738108800000,
    deactivationDateInSeconds: 1738108800,
    deactivationDateDisplay: "29/01/25",
    deactivationDateDisplayISO8601: "2025-01-29",
    sequence: 1,
    periods: 0,
    remainingPeriods: 0,
    begin: 1738132648224,
    beginValue: 1738132648224,
    beginInSeconds: 1738132648,
    beginDisplay: "29/01/25",
    beginDisplayISO8601: "2025-01-29",
    beginDisplayEmailEnhancements: "Jan 29, 2025",
    beginDisplayEmailEnhancementsWithTime: "Jan 29, 2025 06:37:28 AM",
    nextDisplayEmailEnhancements: "Feb 28, 2025",
    nextDisplayEmailEnhancementsWithTime: "Feb 28, 2025 12:00:00 AM",
    intervalUnit: "month",
    intervalUnitAbbreviation: "mo",
    intervalLength: 1,
    intervalLengthGtOne: false,
    paymentReminder: { intervalUnit: "week", intervalLength: 1 },
    paymentOverdue: {
      intervalUnit: "week",
      intervalLength: 1,
      total: 4,
      sent: 0,
    },
    cancellationSetting: {
      cancellation: "AFTER_LAST_NOTIFICATION",
      intervalUnit: "week",
      intervalLength: 1,
    },
    fulfillments: {},
    instructions: [
      {
        product: "test-subscription",
        type: "regular",
        isNotTrial: true,
        periodStartDate: 1738108800000,
        periodStartDateValue: 1738108800000,
        periodStartDateInSeconds: 1738108800,
        periodStartDateDisplay: "29/01/25",
        periodStartDateDisplayISO8601: "2025-01-29",
        periodEndDate: 1738108800000,
        periodEndDateValue: 1738108800000,
        periodEndDateInSeconds: 1738108800,
        periodEndDateDisplay: "29/01/25",
        periodEndDateDisplayISO8601: "2025-01-29",
        intervalUnit: "month",
        intervalLength: 1,
        discountPercent: 0,
        discountPercentValue: 0,
        discountPercentDisplay: "0%",
        discountTotal: 0.0,
        discountTotalDisplay: "₹ 0.00",
        discountTotalInPayoutCurrency: 0.0,
        discountTotalInPayoutCurrencyDisplay: "US$ 0.00",
        unitDiscount: 0.0,
        unitDiscountDisplay: "₹ 0.00",
        unitDiscountInPayoutCurrency: 0.0,
        unitDiscountInPayoutCurrencyDisplay: "US$ 0.00",
        price: 914.0,
        priceDisplay: "₹ 914.00",
        priceInPayoutCurrency: 10.0,
        priceInPayoutCurrencyDisplay: "US$ 10.00",
        priceTotal: 914.0,
        priceTotalDisplay: "₹ 914.00",
        priceTotalInPayoutCurrency: 10.0,
        priceTotalInPayoutCurrencyDisplay: "US$ 10.00",
        unitPrice: 914.0,
        unitPriceDisplay: "₹ 914.00",
        unitPriceInPayoutCurrency: 10.0,
        unitPriceInPayoutCurrencyDisplay: "US$ 10.00",
        total: 914.0,
        totalDisplay: "₹ 914.00",
        totalInPayoutCurrency: 10.0,
        totalInPayoutCurrencyDisplay: "US$ 10.00",
        totalWithTaxes: 1078.52,
        totalWithTaxesDisplay: "₹ 1,078.52",
        totalWithTaxesInPayoutCurrency: 11.8,
        totalWithTaxesInPayoutCurrencyDisplay: "US$ 11.80",
      },
    ],
    initialOrderId: "tWKcpSltQtS1aIaUab1VYQ",
    initialOrderReference: "TESTING123250129-3191-47146",
  }});
});
